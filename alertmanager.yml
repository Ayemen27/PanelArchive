# ==============================================================================
# Alertmanager Configuration for aaPanel
# ==============================================================================
# ØªÙƒÙˆÙŠÙ† Alertmanager Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØ¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
# ÙŠØ¯Ø¹Ù… Slack Ùˆ Email notifications
# ==============================================================================

# ==============================================================================
# Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø© - Global Configuration
# ==============================================================================
global:
  # ÙˆÙ‚Øª Ø­Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ - Time after which an alert is declared resolved
  resolve_timeout: 5m
  
  # SMTP Configuration (for email alerts)
  smtp_from: '${ALERT_EMAIL_FROM}'
  smtp_smarthost: '${SMTP_HOST}:${SMTP_PORT}'
  smtp_auth_username: '${SMTP_USERNAME}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  smtp_require_tls: ${SMTP_STARTTLS_ENABLE:-true}

# ==============================================================================
# Templates (Ø§Ø®ØªÙŠØ§Ø±ÙŠ - ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© Ù‚ÙˆØ§Ù„Ø¨ Ù…Ø®ØµØµØ©)
# ==============================================================================
# templates:
#   - '/etc/alertmanager/templates/*.tmpl'

# ==============================================================================
# Route Tree - Ø´Ø¬Ø±Ø© ØªÙˆØ¬ÙŠÙ‡ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
# ==============================================================================
route:
  # Ø§Ù„Ù…Ø³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ - Default receiver for all alerts
  receiver: 'slack'
  
  # ØªØ¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª - Group alerts by these labels
  group_by: ['service', 'alertname']
  
  # Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø£ÙˆÙ„ - Wait before sending first notification
  group_wait: 30s
  
  # Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ø¥Ø±Ø³Ø§Ù„ ØªØ­Ø¯ÙŠØ«Ø§Øª Ù„Ù„Ù…Ø¬Ù…ÙˆØ¹Ø© - Wait before sending updates for a group
  group_interval: 5m
  
  # Ø§Ù†ØªØ¸Ø§Ø± Ù‚Ø¨Ù„ Ø¥Ø¹Ø§Ø¯Ø© Ø¥Ø±Ø³Ø§Ù„ Ù†ÙØ³ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡ - Wait before resending same alert
  repeat_interval: 12h
  
  # ===========================================================================
  # Routes Ø§Ù„ÙØ±Ø¹ÙŠØ© - Child Routes
  # ===========================================================================
  routes:
    # Critical alerts â†’ Email + Slack
    - match:
        severity: critical
      receiver: 'email-critical'
      group_wait: 10s
      group_interval: 5m
      repeat_interval: 4h
      continue: true  # Ø£ÙŠØ¶Ø§Ù‹ Ø£Ø±Ø³Ù„ Ø¥Ù„Ù‰ slack (default receiver)
    
    # Warning alerts â†’ Slack only (default)
    - match:
        severity: warning
      receiver: 'slack'
      group_wait: 30s
      group_interval: 5m
      repeat_interval: 12h
    
    # Database specific alerts â†’ Ù…Ø³Ø§Ø± Ø®Ø§Øµ
    - match_re:
        category: ^(database|cache)$
      receiver: 'slack'
      group_by: ['service', 'alertname', 'category']
      group_wait: 1m
      repeat_interval: 6h

# ==============================================================================
# Receivers - Ù…Ø³ØªÙ‚Ø¨Ù„ÙŠ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
# ==============================================================================
receivers:
  
  # ==========================================================================
  # Slack Receiver - Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Slack
  # ==========================================================================
  - name: 'slack'
    slack_configs:
      - api_url: '${SLACK_WEBHOOK_URL}'
        channel: '#alerts'
        username: 'aaPanel Alertmanager'
        icon_emoji: ':warning:'
        
        # Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± - Notification title
        title: '{{ if eq .Status "firing" }}ğŸš¨{{ else }}âœ…{{ end }} [{{ .Status | toUpper }}] {{ .CommonLabels.alertname }}'
        
        # Ù†Øµ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø± - Notification text
        text: >-
          {{ range .Alerts }}
            *Alert:* {{ .Labels.alertname }}
            *Severity:* {{ .Labels.severity }}
            *Service:* {{ .Labels.service }}
            *Description:* {{ .Annotations.description }}
            {{ if .Annotations.action }}*Action:* {{ .Annotations.action }}{{ end }}
          {{ end }}
        
        # Ø£Ù„ÙˆØ§Ù† Ø­Ø³Ø¨ Ø§Ù„Ø­Ø§Ù„Ø© - Colors based on status
        color: '{{ if eq .Status "firing" }}{{ if eq .CommonLabels.severity "critical" }}danger{{ else }}warning{{ end }}{{ else }}good{{ end }}'
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ù„ Ø£ÙŠØ¶Ø§Ù‹ - Send notification when resolved
        send_resolved: true
  
  # ==========================================================================
  # Email Receiver for Critical Alerts - Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
  # ==========================================================================
  - name: 'email-critical'
    email_configs:
      - to: '${ALERT_EMAIL_TO}'
        from: '${ALERT_EMAIL_FROM}'
        
        # Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø±ÙŠØ¯ - Email subject
        headers:
          Subject: '[CRITICAL] aaPanel Alert: {{ .CommonLabels.alertname }}'
        
        # Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø¨Ø±ÙŠØ¯ - Email body (HTML)
        html: |
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: Arial, sans-serif; }
              .alert { padding: 15px; margin: 10px 0; border-radius: 5px; }
              .critical { background-color: #f8d7da; border: 1px solid #f5c6cb; }
              .resolved { background-color: #d4edda; border: 1px solid #c3e6cb; }
              .label { font-weight: bold; }
            </style>
          </head>
          <body>
            <h2>{{ if eq .Status "firing" }}ğŸš¨ Critical Alert Firing{{ else }}âœ… Alert Resolved{{ end }}</h2>
            {{ range .Alerts }}
            <div class="alert {{ if eq .Status "firing" }}critical{{ else }}resolved{{ end }}">
              <p><span class="label">Alert:</span> {{ .Labels.alertname }}</p>
              <p><span class="label">Severity:</span> {{ .Labels.severity }}</p>
              <p><span class="label">Service:</span> {{ .Labels.service }}</p>
              <p><span class="label">Instance:</span> {{ .Labels.instance }}</p>
              <p><span class="label">Description:</span> {{ .Annotations.description }}</p>
              {{ if .Annotations.impact }}<p><span class="label">Impact:</span> {{ .Annotations.impact }}</p>{{ end }}
              {{ if .Annotations.action }}<p><span class="label">Action Required:</span> {{ .Annotations.action }}</p>{{ end }}
              <p><span class="label">Started At:</span> {{ .StartsAt.Format "2006-01-02 15:04:05" }}</p>
              {{ if .EndsAt }}<p><span class="label">Ended At:</span> {{ .EndsAt.Format "2006-01-02 15:04:05" }}</p>{{ end }}
            </div>
            {{ end }}
            <hr>
            <p><small>This is an automated alert from aaPanel Alertmanager</small></p>
          </body>
          </html>
        
        # Ø¥Ø±Ø³Ø§Ù„ Ø¹Ù†Ø¯ Ø§Ù„Ø­Ù„ - Send notification when resolved
        send_resolved: true
        
        # Ù…ØªØ·Ù„Ø¨Ø§Øª TLS - TLS requirements
        require_tls: ${SMTP_STARTTLS_ENABLE:-true}

# ==============================================================================
# Inhibition Rules - Ù‚ÙˆØ§Ø¹Ø¯ ØªØ«Ø¨ÙŠØ· Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª
# ==============================================================================
# ØªÙ…Ù†Ø¹ Ø¥Ø±Ø³Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡Ø§Øª warning Ø¹Ù†Ø¯Ù…Ø§ ÙŠÙƒÙˆÙ† Ù‡Ù†Ø§Ùƒ critical alert Ù…Ù† Ù†ÙØ³ Ø§Ù„Ø®Ø¯Ù…Ø©
inhibit_rules:
  
  # Critical alerts ØªØ«Ø¨Ø· Warning alerts
  - source_match:
      severity: 'critical'
    target_match:
      severity: 'warning'
    equal: ['service', 'alertname']
  
  # Critical CPU ÙŠØ«Ø¨Ø· High CPU
  - source_match:
      alertname: 'CriticalCPUUsage'
    target_match:
      alertname: 'HighCPUUsage'
    equal: ['service', 'instance']
  
  # Critical Memory ÙŠØ«Ø¨Ø· High Memory
  - source_match:
      alertname: 'CriticalMemoryUsage'
    target_match:
      alertname: 'HighMemoryUsage'
    equal: ['service', 'instance']
  
  # Critical Disk ÙŠØ«Ø¨Ø· High Disk
  - source_match:
      alertname: 'CriticalDiskUsage'
    target_match:
      alertname: 'HighDiskUsage'
    equal: ['service', 'instance']
  
  # Application Down ÙŠØ«Ø¨Ø· Ø¬Ù…ÙŠØ¹ Ø§Ù„ØªÙ†Ø¨ÙŠÙ‡Ø§Øª Ø§Ù„Ø£Ø®Ø±Ù‰
  - source_match:
      alertname: 'ApplicationDown'
    target_match_re:
      alertname: '^(High|Critical).*'
    equal: ['service', 'instance']

# ==============================================================================
# Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ù…Ù‡Ù…Ø© - Important Notes
# ==============================================================================
#
# 1. Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© - Environment Variables:
#    - ÙŠØ¬Ø¨ ØªØ¹Ø±ÙŠÙ Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª ÙÙŠ Ù…Ù„Ù .env
#    - Ø§Ø³ØªØ®Ø¯Ù… .env.alerting.example ÙƒÙ…Ø±Ø¬Ø¹
#
# 2. Ø§Ø®ØªØ¨Ø§Ø± Ø§Ù„ØªÙƒÙˆÙŠÙ† - Testing Configuration:
#    amtool check-config alertmanager.yml
#
# 3. Slack Webhook:
#    - Ø§Ø­ØµÙ„ Ø¹Ù„Ù‰ webhook URL Ù…Ù†: https://api.slack.com/messaging/webhooks
#    - Ø£Ø¶ÙÙ‡ Ø¥Ù„Ù‰ .env ÙƒÙ€ SLACK_WEBHOOK_URL
#
# 4. SMTP Configuration:
#    - Gmail: smtp.gmail.com:587 (ÙŠØªØ·Ù„Ø¨ App Password)
#    - SendGrid: smtp.sendgrid.net:587
#    - Mailgun: smtp.mailgun.org:587
#
# 5. Ø§Ù„Ø£Ù…Ø§Ù† - Security:
#    - Ù„Ø§ ØªØ¶Ø¹ credentials Ù…Ø¨Ø§Ø´Ø±Ø© ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ù…Ù„Ù
#    - Ø§Ø³ØªØ®Ø¯Ù… Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦Ø© Ø¯Ø§Ø¦Ù…Ø§Ù‹
#    - Ø§Ø­Ù…Ù Ù…Ù„Ù .env (Ù„Ø§ ØªØ´Ø§Ø±ÙƒÙ‡ ÙÙŠ git)
#
# ==============================================================================
