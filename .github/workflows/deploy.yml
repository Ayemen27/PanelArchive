# ==================== GitHub Actions: Auto Deploy to VPS ====================
# Ù†Ø´Ø± ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¢Ù…Ù† Ø¥Ù„Ù‰ VPS Ù…Ø¹ health checks Ùˆ rollback

name: Deploy to VPS

on:
  workflow_run:
    workflows: ["Build & Push Docker Image"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  DEPLOY_PATH: /opt/aapanel

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    # ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† build Ù†Ø§Ø¬Ø­ (Ù„Ù„Ù€ workflow_run trigger)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://${{ secrets.VPS_DOMAIN }}
    
    steps:
      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 1: Checkout Ø§Ù„ÙƒÙˆØ¯ ====================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªØ¬Ù‡ÙŠØ² SSH Key ====================
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 2.5: Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø­Ø±Ø¬Ø© ====================
      - name: Validate critical environment variables
        run: |
          echo "ğŸ” Validating critical environment variables..."
          VALIDATION_FAILED=0
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ù…ØªØºÙŠØ±Ø§Øª GitHub Secrets
          if [ -z "${{ secrets.VPS_HOST }}" ]; then
            echo "âŒ VPS_HOST is not set in GitHub secrets"
            VALIDATION_FAILED=1
          else
            echo "âœ… VPS_HOST is set"
          fi
          
          if [ -z "${{ secrets.VPS_USER }}" ]; then
            echo "âŒ VPS_USER is not set in GitHub secrets"
            VALIDATION_FAILED=1
          else
            echo "âœ… VPS_USER is set"
          fi
          
          if [ -z "${{ secrets.VPS_SSH_KEY }}" ]; then
            echo "âŒ VPS_SSH_KEY is not set in GitHub secrets"
            VALIDATION_FAILED=1
          else
            echo "âœ… VPS_SSH_KEY is set"
          fi
          
          if [ -z "${{ secrets.VPS_DOMAIN }}" ]; then
            echo "âŒ VPS_DOMAIN is not set in GitHub secrets"
            VALIDATION_FAILED=1
          else
            echo "âœ… VPS_DOMAIN is set"
          fi
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† SECRET_KEY Ø¹Ù„Ù‰ VPS
          echo ""
          echo "ğŸ” Validating SECRET_KEY on VPS..."
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
          
          cd ${{ env.DEPLOY_PATH }}
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ .env (Ø¥Ù„Ø²Ø§Ù…ÙŠ Ù„Ù„Ø¥Ù†ØªØ§Ø¬)
          if [ ! -f .env ]; then
            if [ "${{ github.event.inputs.environment || 'production' }}" = "production" ]; then
              echo "âŒ .env file not found on VPS for production deployment"
              echo "   Production deployments require pre-configured .env with SECRET_KEY"
              exit 1
            else
              echo "âš ï¸  .env file not found - will be created during staging deployment"
              exit 0
            fi
          fi
          
          # Ø§Ø³ØªØ®Ø±Ø§Ø¬ SECRET_KEY Ù…Ù† .env
          SECRET_KEY=$(grep '^SECRET_KEY=' .env 2>/dev/null | cut -d'=' -f2- | tr -d '"' | tr -d "'" | xargs)
          
          if [ -z "$SECRET_KEY" ]; then
            echo "âŒ SECRET_KEY is not set in .env"
            exit 1
          fi
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø·ÙˆÙ„ SECRET_KEY
          SECRET_KEY_LENGTH=${#SECRET_KEY}
          if [ $SECRET_KEY_LENGTH -lt 32 ]; then
            echo "âŒ SECRET_KEY is too short: $SECRET_KEY_LENGTH chars (minimum: 32)"
            exit 1
          fi
          
          # Ø±ÙØ¶ placeholder values
          if echo "$SECRET_KEY" | grep -qE '(your-secret|change.*me|example|test.*secret|placeholder|xxx+|aaa+)'; then
            echo "âŒ SECRET_KEY appears to be a placeholder value"
            exit 1
          fi
          
          echo "âœ… SECRET_KEY is valid ($SECRET_KEY_LENGTH chars)"
          
          # Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† DATABASE Ù„Ù„Ø¥Ù†ØªØ§Ø¬ ÙÙ‚Ø·
          if [ "${{ github.event.inputs.environment || 'production' }}" = "production" ]; then
            # Ø§Ø³ØªØ®Ø±Ø§Ø¬ DATABASE_URI Ùˆ DATABASE_URL Ù…Ù† .env
            DATABASE_URI=$(grep '^DATABASE_URI=' .env 2>/dev/null | cut -d'=' -f2- | tr -d '"' | tr -d "'" | xargs)
            DATABASE_URL=$(grep '^DATABASE_URL=' .env 2>/dev/null | cut -d'=' -f2- | tr -d '"' | tr -d "'" | xargs)
            
            if [ -z "$DATABASE_URI" ] && [ -z "$DATABASE_URL" ]; then
              echo "âš ï¸  DATABASE_URI/DATABASE_URL not set (SQLite will be used)"
              echo "   â„¹ï¸  Production typically requires PostgreSQL or MySQL"
            else
              echo "âœ… Database connection is configured"
            fi
          fi
          
          exit 0
          ENDSSH
          
          # ÙØ­Øµ Ù†ØªÙŠØ¬Ø© SSH
          SSH_RESULT=$?
          if [ $SSH_RESULT -ne 0 ]; then
            echo "âŒ VPS environment validation failed"
            VALIDATION_FAILED=1
          fi
          
          # Ø§Ù„Ø®Ø±ÙˆØ¬ Ø¨ÙØ´Ù„ Ø¥Ø°Ø§ ÙØ´Ù„ Ø£ÙŠ ÙØ­Øµ
          if [ $VALIDATION_FAILED -eq 1 ]; then
            echo ""
            echo "âŒ Environment validation failed! Deployment aborted."
            exit 1
          fi
          
          echo ""
          echo "âœ… All critical environment variables validated successfully!"

      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 3: Ø­ÙØ¸ Ø§Ù„ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø­Ø§Ù„ÙŠ ====================
      - name: Backup current configuration
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
          cd ${{ env.DEPLOY_PATH }}
          
          # Ø­ÙØ¸ docker-compose.yml Ø§Ù„Ø­Ø§Ù„ÙŠ Ù‚Ø¨Ù„ Ø§Ù„Ø§Ø³ØªØ¨Ø¯Ø§Ù„
          if [ -f docker-compose.yml ]; then
            cp docker-compose.yml docker-compose.prev.yml
            echo "âœ… Backed up current docker-compose.yml to docker-compose.prev.yml"
          else
            echo "â„¹ï¸  No existing docker-compose.yml to backup (first deployment)"
          fi
          ENDSSH
      
      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 4: Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Ø§Ù„Ù†Ø´Ø± ====================
      - name: Copy deployment files to VPS
        run: |
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            docker-compose.prod.yml \
            .env.example \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ env.DEPLOY_PATH }}/
          
          # Ø§Ø³ØªØ¨Ø¯Ø§Ù„ Ø¨Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø¬Ø¯ÙŠØ¯
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "cd ${{ env.DEPLOY_PATH }} && mv docker-compose.prod.yml docker-compose.yml && echo 'âœ… Deployed new docker-compose.yml'"

      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 5: Ù†Ø³Ø® Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ù†Ø´Ø± ====================
      - name: Copy deploy script
        run: |
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            deploy.sh \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ env.DEPLOY_PATH }}/
          
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "chmod +x ${{ env.DEPLOY_PATH }}/deploy.sh"

      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 6: ØªÙ†ÙÙŠØ° Ø§Ù„Ù†Ø´Ø± ====================
      - name: Execute deployment
        id: deploy
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
          
          # Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù†Ø´Ø±
          cd ${{ env.DEPLOY_PATH }}
          
          # ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
          export REGISTRY=${{ env.REGISTRY }}
          export IMAGE_NAME=${{ env.IMAGE_NAME }}
          export IMAGE_TAG=latest
          
          # ØªØ´ØºÙŠÙ„ Ø³ÙƒØ±ÙŠØ¨Øª Ø§Ù„Ù†Ø´Ø±
          ./deploy.sh
          
          ENDSSH

      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 7: Health Check ====================
      - name: Health check
        run: |
          echo "Waiting for application to start..."
          sleep 15
          
          # ÙØ­Øµ Ø§Ù„ØµØ­Ø©
          MAX_RETRIES=10
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s https://${{ secrets.VPS_DOMAIN }}/health > /dev/null 2>&1 || \
               curl -f -s https://${{ secrets.VPS_DOMAIN }}/ > /dev/null 2>&1; then
              echo "âœ… Health check passed!"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Health check attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying..."
            sleep 5
          done
          
          echo "âŒ Health check failed after $MAX_RETRIES attempts"
          exit 1

      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 8: Rollback Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„ ====================
      - name: Rollback on failure
        if: failure()
        run: |
          echo "âš ï¸  Deployment failed, initiating rollback..."
          
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
          
          cd ${{ env.DEPLOY_PATH }}
          
          # Ø§Ù„ØªØ±Ø§Ø¬Ø¹ Ù„Ù„Ø¥ØµØ¯Ø§Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚
          if [ -f docker-compose.prev.yml ]; then
            echo "Rolling back to previous version..."
            cp docker-compose.prev.yml docker-compose.yml
            
            # Ø¥Ø¹Ø§Ø¯Ø© ØªØ´ØºÙŠÙ„ Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙƒÙˆÙŠÙ† Ø§Ù„Ø³Ø§Ø¨Ù‚
            docker-compose up -d --force-recreate
            echo "âœ… Rollback completed - restored previous configuration"
          else
            echo "âš ï¸  No previous version found for rollback"
            echo "Attempting to restart current version..."
            docker-compose restart
          fi
          
          ENDSSH

      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 9: Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ù„Ù†Ø¬Ø§Ø­ ====================
      - name: Deployment success notification
        if: success()
        run: |
          echo "### ğŸš€ Deployment Successful! ###"
          echo ""
          echo "**Environment:** ${{ github.event.inputs.environment || 'production' }}"
          echo "**Image:** ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo "**URL:** https://${{ secrets.VPS_DOMAIN }}"
          echo ""
          echo "âœ… Application is now live!"

      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 9: ØªÙ†Ø¸ÙŠÙ ====================
      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key
