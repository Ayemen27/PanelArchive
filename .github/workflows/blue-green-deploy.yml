# ==================== GitHub Actions: Blue-Green Deployment ====================
# Ù†Ø´Ø± Blue-Green Ø¨Ø¯ÙˆÙ† downtime Ù…Ø¹ rollback ØªÙ„Ù‚Ø§Ø¦ÙŠ

name: Blue-Green Deployment

on:
  workflow_run:
    workflows: ["Build & Push Docker Image"]
    types:
      - completed
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Target environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      force_color:
        description: 'Force specific color (leave empty for auto-detect)'
        required: false
        type: choice
        options:
          - ''
          - blue
          - green

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}
  DEPLOY_PATH: /opt/aapanel

jobs:
  blue-green-deploy:
    name: Blue-Green Deploy to ${{ github.event.inputs.environment || 'production' }}
    runs-on: ubuntu-latest
    # ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† build Ù†Ø§Ø¬Ø­ (Ù„Ù„Ù€ workflow_run trigger)
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    environment: 
      name: ${{ github.event.inputs.environment || 'production' }}
      url: https://${{ secrets.VPS_DOMAIN }}
    
    steps:
      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 1: Checkout Ø§Ù„ÙƒÙˆØ¯ ====================
      - name: Checkout repository
        uses: actions/checkout@v4

      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 2: ØªØ¬Ù‡ÙŠØ² SSH Key ====================
      - name: Setup SSH key
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/deploy_key
          chmod 600 ~/.ssh/deploy_key
          ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts

      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 3: Ù†Ø³Ø® Ù…Ù„ÙØ§Øª Blue-Green ====================
      - name: Copy Blue-Green deployment files
        run: |
          # Ù†Ø³Ø® docker-compose files (shared + blue + green)
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            docker-compose.shared.yml \
            docker-compose.blue.yml \
            docker-compose.green.yml \
            .env.example \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ env.DEPLOY_PATH }}/

      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 4: Ù†Ø³Ø® Ø§Ù„Ø³ÙƒØ±ÙŠØ¨ØªØ§Øª ====================
      - name: Copy deployment scripts
        run: |
          scp -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            blue-green-deploy.sh \
            switch.sh \
            nginx-blue-green.conf.template \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }}:${{ env.DEPLOY_PATH }}/
          
          # Ø¬Ø¹Ù„ Ø§Ù„Ø³ÙƒØ±ÙŠØ¨ØªØ§Øª Ù‚Ø§Ø¨Ù„Ø© Ù„Ù„ØªÙ†ÙÙŠØ°
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "chmod +x ${{ env.DEPLOY_PATH }}/blue-green-deploy.sh ${{ env.DEPLOY_PATH }}/switch.sh"

      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 5: Ø§ÙƒØªØ´Ø§Ù Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù†Ø´Ø·Ø© ====================
      - name: Detect active environment
        id: detect
        run: |
          ACTIVE_ENV=$(ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
            "cd ${{ env.DEPLOY_PATH }} && cat .active_environment 2>/dev/null || echo 'none'")
          
          echo "Current active environment: ${ACTIVE_ENV}"
          echo "active_env=${ACTIVE_ENV}" >> $GITHUB_OUTPUT
          
          # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù…Ø³ØªÙ‡Ø¯ÙØ©
          if [ "${{ github.event.inputs.force_color }}" != "" ]; then
            TARGET_ENV="${{ github.event.inputs.force_color }}"
            echo "Using forced target: ${TARGET_ENV}"
          elif [ "${ACTIVE_ENV}" == "blue" ]; then
            TARGET_ENV="green"
          elif [ "${ACTIVE_ENV}" == "green" ]; then
            TARGET_ENV="blue"
          else
            TARGET_ENV="blue"
          fi
          
          echo "Target environment: ${TARGET_ENV}"
          echo "target_env=${TARGET_ENV}" >> $GITHUB_OUTPUT

      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 6: ØªÙ†ÙÙŠØ° Blue-Green Deployment ====================
      - name: Execute Blue-Green deployment
        id: deploy
        env:
          ACTIVE_ENV: ${{ steps.detect.outputs.active_env }}
          TARGET_ENV: ${{ steps.detect.outputs.target_env }}
        run: |
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
          
          # Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ Ù„Ù…Ø¬Ù„Ø¯ Ø§Ù„Ù†Ø´Ø±
          cd ${{ env.DEPLOY_PATH }}
          
          # ØªØµØ¯ÙŠØ± Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª
          export REGISTRY=${{ env.REGISTRY }}
          export IMAGE_NAME=${{ env.IMAGE_NAME }}
          export IMAGE_TAG=latest
          
          # ØªØ´ØºÙŠÙ„ Ø³ÙƒØ±ÙŠØ¨Øª Blue-Green deployment
          echo "Starting Blue-Green deployment..."
          echo "Current active: ${ACTIVE_ENV}"
          echo "Deploying to: ${TARGET_ENV}"
          
          ./blue-green-deploy.sh
          
          ENDSSH

      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 7: Health Check Ù„Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© ====================
      - name: Health check - New environment
        env:
          TARGET_ENV: ${{ steps.detect.outputs.target_env }}
        run: |
          echo "Verifying new environment health..."
          
          # ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…Ù†ÙØ° Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ¦Ø©
          if [ "$TARGET_ENV" == "blue" ]; then
            TARGET_PORT=5001
          else
            TARGET_PORT=5002
          fi
          
          # ÙØ­Øµ Ø§Ù„ØµØ­Ø© Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
          MAX_RETRIES=10
          RETRY_COUNT=0
          
          sleep 15
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            # ÙØ­Øµ Ø¹Ø¨Ø± Ø§Ù„Ù…Ù†ÙØ° Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
            if ssh -i ~/.ssh/deploy_key \
                -o StrictHostKeyChecking=no \
                ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} \
                "curl -f -s http://localhost:${TARGET_PORT}/health > /dev/null 2>&1 || curl -f -s http://localhost:${TARGET_PORT}/ > /dev/null 2>&1"; then
              echo "âœ… Direct port health check passed (port ${TARGET_PORT})"
              break
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Health check attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying..."
            sleep 5
          done
          
          if [ $RETRY_COUNT -ge $MAX_RETRIES ]; then
            echo "âŒ Health check failed after $MAX_RETRIES attempts"
            exit 1
          fi

      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 8: Health Check Ø¹Ø¨Ø± nginx ====================
      - name: Health check - Via nginx
        run: |
          echo "Verifying service via nginx/load balancer..."
          sleep 10
          
          MAX_RETRIES=10
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            if curl -f -s https://${{ secrets.VPS_DOMAIN }}/health > /dev/null 2>&1 || \
               curl -f -s https://${{ secrets.VPS_DOMAIN }}/ > /dev/null 2>&1; then
              echo "âœ… Service health check passed via nginx!"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            echo "Nginx health check attempt $RETRY_COUNT/$MAX_RETRIES failed, retrying..."
            sleep 5
          done
          
          echo "âš ï¸  Nginx health check failed - may need manual verification"
          # Ù„Ø§ Ù†ÙØ´Ù„ Ù‡Ù†Ø§ Ù„Ø£Ù† Ø§Ù„Ø®Ø¯Ù…Ø© Ù‚Ø¯ ØªÙƒÙˆÙ† ØªØ¹Ù…Ù„ ÙˆÙ„ÙƒÙ† nginx Ù„Ù… ÙŠÙØ­Ø¯ÙÙ‘Ø«

      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 9: Rollback Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„ ====================
      - name: Rollback on failure
        if: failure()
        env:
          ACTIVE_ENV: ${{ steps.detect.outputs.active_env }}
          TARGET_ENV: ${{ steps.detect.outputs.target_env }}
        run: |
          echo "âš ï¸  Deployment failed, initiating rollback..."
          
          ssh -i ~/.ssh/deploy_key \
            -o StrictHostKeyChecking=no \
            ${{ secrets.VPS_USER }}@${{ secrets.VPS_HOST }} << 'ENDSSH'
          
          cd ${{ env.DEPLOY_PATH }}
          
          # Ø¥ÙŠÙ‚Ø§Ù Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„ÙØ§Ø´Ù„Ø©
          echo "Stopping failed ${TARGET_ENV} environment..."
          docker-compose -f docker-compose.${TARGET_ENV}.yml down
          
          # Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ØªØ¹Ù…Ù„
          if [ "${ACTIVE_ENV}" != "none" ]; then
            echo "Ensuring ${ACTIVE_ENV} environment is running..."
            
            if ! docker ps | grep -q "aapanel_app_${ACTIVE_ENV}"; then
              echo "Starting ${ACTIVE_ENV} environment..."
              docker-compose -f docker-compose.${ACTIVE_ENV}.yml up -d
            fi
            
            echo "âœ… Rollback completed - ${ACTIVE_ENV} environment is active"
          else
            echo "âš ï¸  No previous environment to rollback to (first deployment)"
          fi
          
          ENDSSH

      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 10: Ø¥Ø´Ø¹Ø§Ø± Ø¨Ø§Ù„Ù†Ø¬Ø§Ø­ ====================
      - name: Deployment success notification
        if: success()
        env:
          TARGET_ENV: ${{ steps.detect.outputs.target_env }}
        run: |
          echo "### ğŸš€ Blue-Green Deployment Successful! ###"
          echo ""
          echo "**Environment:** ${{ github.event.inputs.environment || 'production' }}"
          echo "**Deployed to:** ${TARGET_ENV^^}"
          echo "**Image:** ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest"
          echo "**URL:** https://${{ secrets.VPS_DOMAIN }}"
          echo ""
          echo "âœ… Zero-downtime deployment completed!"

      # ==================== Ø§Ù„Ø®Ø·ÙˆØ© 11: ØªÙ†Ø¸ÙŠÙ ====================
      - name: Cleanup
        if: always()
        run: |
          rm -f ~/.ssh/deploy_key

# ==============================================================================
# Workflow Features:
# ==============================================================================
# 1. Auto-detection: ÙŠÙƒØªØ´Ù Ø§Ù„Ø¨ÙŠØ¦Ø© Ø§Ù„Ù†Ø´Ø·Ø© ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹
# 2. Zero-downtime: Ù†Ø´Ø± Ø¨Ø¯ÙˆÙ† ØªÙˆÙ‚Ù Ø§Ù„Ø®Ø¯Ù…Ø©
# 3. Health checks: ÙØ­Øµ ØµØ­Ø© Ø´Ø§Ù…Ù„ Ù‚Ø¨Ù„ Ø§Ù„ØªØ¨Ø¯ÙŠÙ„
# 4. Automatic rollback: ØªØ±Ø§Ø¬Ø¹ ØªÙ„Ù‚Ø§Ø¦ÙŠ Ø¹Ù†Ø¯ Ø§Ù„ÙØ´Ù„
# 5. Manual override: Ø¥Ù…ÙƒØ§Ù†ÙŠØ© Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¨ÙŠØ¦Ø© ÙŠØ¯ÙˆÙŠØ§Ù‹
# ==============================================================================
