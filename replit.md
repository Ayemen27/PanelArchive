# aaPanel - لوحة تحكم الخادم

## نظرة عامة على المشروع

**aaPanel** هو لوحة تحكم قوية لإدارة الخوادم مكتوبة بلغة Python/Flask. يتيح للمستخدمين إدارة الخوادم بسهولة من خلال واجهة ويب رسومية.

### المعلومات الأساسية
- **اللغة الأساسية**: Python 3.12
- **الإطار**: Flask مع Gunicorn
- **قاعدة البيانات**: SQLite (محلياً) / MySQL/PostgreSQL (إنتاج)
- **المنفذ الافتراضي**: 5000
- **المسار الافتراضي للإنتاج**: `/www/server/panel`

---

## الوضع الحالي للمشروع (آخر تحديث: 30 سبتمبر 2025)

### ✅ ما تم إنجازه
1. **نظام اكتشاف البيئة**: ✅ مكتمل (نسبة الإنجاز: 100%)
   - ملف `environment_detector.py` يكتشف البيئة تلقائياً
   - يميز بين Replit و VPS بدقة عالية
   - دعم التحكم اليدوي عبر متغير ENVIRONMENT
   - 14 اختبار ناجح بنسبة 100%

2. **Factory Pattern للإعدادات**: ✅ مكتمل (نسبة الإنجاز: 100%)
   - ملف `config_factory.py` يوفر نظام إعدادات موحد
   - BaseConfig، DevelopmentConfig، ProductionConfig
   - دالة `get_config()` للحصول على الإعدادات تلقائياً
   - 54 اختبار ناجح بنسبة 100%
   - إلزام SECRET_KEY في الإنتاج
   - دعم MySQL+PyMySQL و PostgreSQL

3. **البنية الأساسية**: 
   - التطبيق يعمل على Replit
   - ملف `.env` تم إعداده مع المتغيرات الأساسية
   - `runserver.py` جاهز ويعمل

4. **قاعدة البيانات**:
   - دعم متعدد لقواعد البيانات (SQLite, MySQL, PostgreSQL)
   - نظام migrations متقدم

5. **الأمان**:
   - نظام مراقبة أمني متقدم
   - دعم SSL/HTTPS
   - جدار حماية

### ⚠️ ما يحتاج تطوير
1. **متغيرات البيئة**: تحتاج تنظيم أفضل (نسبة الإنجاز: 60%) - يحتوي .env على أسرار يجب حمايتها
2. **CI/CD Pipeline**: غير موجود (نسبة الإنجاز: 0%)
3. **نظام المراقبة والتنبيهات**: غير موجود (نسبة الإنجاز: 0%)

---

## البيئات المستهدفة

### 1. بيئة التطوير (Replit)
- المنفذ: ديناميكي من متغير `PORT`
- قاعدة البيانات: SQLite محلية
- بدون nginx
- وضع DEBUG مفعّل

### 2. بيئة الإنتاج (VPS)
- المنفذ: 5000 (خلف nginx)
- قاعدة البيانات: MySQL/PostgreSQL خارجية
- nginx كـ reverse proxy مع SSL
- systemd لإدارة العمليات

---

## البنية التقنية الحالية

### الملفات الرئيسية
- `runserver.py` - نقطة دخول التطبيق
- `runconfig.py` - إعدادات Gunicorn
- `environment_detector.py` - ✨ اكتشاف البيئة التلقائي
- `config_factory.py` - ✨ **جديد**: نظام الإعدادات الموحد (Factory Pattern)
- `BTPanel/__init__.py` - تهيئة Flask
- `class/config.py` - إعدادات قديمة
- `class_v2/config_v2.py` - إعدادات محدثة

### المجلدات المهمة
- `BTPanel/` - التطبيق الأساسي
- `class/` & `class_v2/` - المنطق البرمجي
- `data/` - ملفات البيانات والإعدادات
- `config/` - ملفات الإعدادات
- `vhost/` - إعدادات nginx/apache

---

## طريقة استخدام نظام اكتشاف البيئة

### الاستيراد والاستخدام الأساسي
```python
# استيراد الدوال الأساسية
from environment_detector import detect_environment, is_replit, is_production, get_environment_info

# اكتشاف البيئة الحالية
env = detect_environment()
print(f"البيئة الحالية: {env}")  # 'development' أو 'production'

# التحقق من نوع البيئة
if is_replit():
    print("نحن في بيئة Replit")
    
if is_production():
    print("نحن في بيئة الإنتاج")
```

### الحصول على معلومات تفصيلية
```python
# الحصول على معلومات شاملة عن البيئة
info = get_environment_info()
print(f"البيئة: {info['environment']}")
print(f"Replit: {info['is_replit']}")
print(f"إنتاج: {info['is_production']}")
print(f"نسخة Python: {info['python_version']}")
```

### التحكم اليدوي بالبيئة
يمكنك التحكم يدوياً بالبيئة عبر متغير `ENVIRONMENT`:

```bash
# في ملف .env أو terminal
ENVIRONMENT=development  # لفرض بيئة التطوير
ENVIRONMENT=production   # لفرض بيئة الإنتاج
ENVIRONMENT=prod        # يعمل أيضاً
ENVIRONMENT=dev         # يعمل أيضاً
```

**ملاحظة**: التحكم اليدوي له الأولوية على الاكتشاف التلقائي.

---

## تفضيلات المستخدم والفريق

### متطلبات التوثيق
- يجب تحديث حالة كل مهمة فور إنجازها
- توثيق واضح لما تم إنجازه وما تبقى
- تمكين الفريق من معرفة نقطة التوقف ونقطة الاستكمال

### التواصل
- **اللغة المفضلة**: العربية فقط في جميع الردود
- التوثيق يجب أن يكون واضح ومفصل

---

## القرارات المعمارية

### القرار 1: استخدام Factory Pattern للإعدادات
- **التاريخ**: 30 سبتمبر 2025
- **السبب**: لتسهيل التبديل بين بيئات مختلفة والحفاظ على نظافة الكود
- **الحالة**: ✅ تم التنفيذ
- **الملفات**: `config_factory.py`

### القرار 2: اعتماد Docker للنقل
- **التاريخ**: 30 سبتمبر 2025
- **السبب**: ضمان توافق البيئات
- **الحالة**: قيد التخطيط

---

## المشاكل المعروفة

1. **التعقيد**: البنية معقدة ومصممة للـ VPS أكثر من التطوير المحلي
2. **الاعتماديات**: بعض الميزات تتطلب root access وخدمات نظام
3. **التوافق**: بعض الميزات قد لا تعمل في Replit

---

## الملاحظات الفنية

### نقاط مهمة للمطورين
- التطبيق يستخدم Gunicorn مع GeventWebSocketWorker
- المسار الافتراضي محدد في الكود: `/www/server/panel`
- المنفذ يُقرأ من ملف `data/port.pl`
- دعم WebSocket موجود

### تحذيرات
- لا تشغل التطبيق كـ root
- تأكد من وجود المجلدات المطلوبة قبل التشغيل
- بعض الميزات تحتاج صلاحيات نظام

---

## آخر التغييرات (السجل)

### 30 سبتمبر 2025 - المساء
- ✅ **المهمة 1.2 مكتملة**: تم إنشاء ملف `config_factory.py`
  - نظام إعدادات موحد (Factory Pattern)
  - BaseConfig، DevelopmentConfig، ProductionConfig
  - دالة `get_config()` للحصول على الإعدادات تلقائياً
  - 54 اختبار ناجح بنسبة 100%
  - إلزام SECRET_KEY في الإنتاج للأمان
  - دعم MySQL+PyMySQL و PostgreSQL
  - إصلاح 3 مشاكل حرجة حددها Architect
  - تحديث التوثيق الكامل (replit.md، خطة_التطوير.md، قائمة_التحقق.md)
  - رفع التقدم الإجمالي من 51% إلى 60%

- ✅ **المهمة 1.1 مكتملة**: تم إنشاء ملف `environment_detector.py`
  - نظام اكتشاف بيئة متقدم (Replit/VPS)
  - 14 اختبار ناجح بنسبة 100%
  - يكتشف البيئة بدقة عالية
  - يدعم التحكم اليدوي عبر متغير ENVIRONMENT
  - توثيق شامل بالعربية

- ⚠️ **تنبيه أمني**: تم رصد أسرار حساسة في .env (سيتم معالجتها في المهمة 1.3)

### 30 سبتمبر 2025
- تم إنشاء ملف التوثيق الأولي
- تم فحص البنية الحالية
- تم تحديد نقاط الضعف والقوة
